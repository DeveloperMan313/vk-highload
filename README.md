# Курсовая работа по курсу "Проектирование высоконагруженных систем"

Студент: Волощук А. Д.
Группа: WEB-41 (осень 2025)

# Quora

## 1. Тема и целевая аудитория

**Тип сервиса**: вопросно-ответный форум, сфокусированный на формировании качественной базы знаний

**Местоположение целевой аудитории**: мир

**MAU**: 400M ([1](https://www.demandsage.com/quora-statistics/))
**DAU**: 27M ([1](https://www.demandsage.com/quora-statistics/))

**Основные регионы по числу посещений** ([1](https://www.demandsage.com/quora-statistics/)):

| Страна/Регион | Число пользователей |
|---------------|---------------------|
| США | 148M |
| Индия | 100M |
| Европа | 78M |
| Юго-Восточная Азия | 24M |
| Великобритания | 22.5M |
| Средний Восток и Северная Африка | 15M |
| Канада | 20M |
| Австралия и Новая Зеландия | 11M |
| Япония | 6.8M |
| Мексика | 3.5M |
| Бразилия | 2.6M |

**Ключевой функционал** - создание и поиск вопросов/ответов

**Ключевое продуктовое решение** - алгоритм ранжирует ответы по полезности, а не по новизне

**Основной функционал MVP**:
* Авторизация и настройка профиля
* Поиск вопроса/ответа
* Создание вопроса
* Создание ответа на вопрос
* Присоединение к Теме
* Голос за/против ответа
* Подписаться на пользователя

## 2. Расчет нагрузки

### Продуктовые показатели:

| Название | Показатель | Расчет |
|----------|------------|--------|
| MAU | 400M | из ([1](https://www.demandsage.com/quora-statistics/)) |
| DAU | 27M | из ([1](https://www.demandsage.com/quora-statistics/)) |
| Число пользователей | 430M | из ([1](https://www.demandsage.com/quora-statistics/)) |
| Вопросов в день | 4000 | из ([1](https://www.demandsage.com/quora-statistics/)) |
| Ср. ответов на вопрос | 5 | из ([1](https://www.demandsage.com/quora-statistics/)) |
| Время на сайте | 9 мин/день | из ([1](https://www.demandsage.com/quora-statistics/)) |
| Число тем | 300K | из ([1](https://www.demandsage.com/quora-statistics/)) |
| Всего вопросов | 5.84M | 16лет * 365дн/год * 4000/день / 4, где 16 - возраст сервиса, /4 - учет нелинейности роста |
| Всего ответов | 29.2M | 5.84M * 5 |
| Ср. ответов на вопрос | 0.71 /день | самостоятельное исследование, отношение числа ответов на вопрос к его возрасту в днях за много лет |
| Ср. размер изображения ответа | 86.8 КБ | самостоятельное исследование |
| Ср. размер изображения профиля | 16 КБ | самостоятельное исследование |
| Ср. размер вопроса | 75 Б | самостоятельное исследование: 50 символов * 1.5Б (ср. символ Unicode) |
| Ср. размер текста ответа | 639 Б | самостоятельное исследование: 426 символов * 1.5Б (ср. символ Unicode) |
| Ср. изображений на ответ | 0.85 | самостоятельное исследование: большой коэффициент, т.к. многие ответы содержат несколько изображений |
| Ср. просмотров ответа | 4.35 /день | самостоятельное исследование |
| Шанс оценки ответа при просмотре | 0.05 | самостоятельное исследование |

### RPS/трафик:

| Запрос | RPS | Расчет RPS | Трафик | Расчет трафика |
|--------|-----|------------|--------|----------------|
| Отправка вопросов | 0.05 | 4000/день / 86400с/день | 3.45 Б/с | 75Б * 0.046/с |
| Отправка текста ответов | 24 | положим, что пользователи отвечают только на вопросы не старше 2х лет (их q_2yr = 2года * 365дн/год * 4000/день, возьмем 4000/день как постоянную), тогда RPS ответов q_2yr * 0.71/день / 86400с/день | 40 КБ/с | оценим средний вес HTTP запроса/ответа с куками в 1КБ, тогда трафик (1КБ + 0.639КБ) * 24/с |
| Отправка изображений ответов | 21 | 24/с * 0.85 | 3.56 МБ/с | 86.8КБ * 21/с |
| Просмотр текста ответов | 1470 | из статистики просмотров ответов (т.к. она за долгое время, можем применить к общему количеству ответов): 29.2M * 4.35/день / 86400с/день | 2.4 МБ/с | (1КБ + 0.639КБ) * 1470/с |
| Просмотр изображений ответов | 1250 | 0.85 * 1470/с | 109 МБ/с | 86.8КБ * 1250/с |
| Оценка ответов | 74 | 1470/с * 0.05 | 74 КБ/с | 1КБ * 74/с |
| Поиск | 313 | 27M/день / 86400с/день | 313 КБ/с | 1КБ * 313/с |
| Получение статики | 313 | 27M/день / 86400с/день | 228 МБ/с | передается статики без кеша 7МБ, с кешем - 30КБ, допустим, каждый 10й пользователь без кеша: 313/с * (1/10 * 7МБ + 9/10 * 0.03МБ) |
| Итог | = ~3500 | | = ~350 МБ/с | |

### Объем хранилищ:

| Тип | Объем | Расчет |
|-----|-------|--------|
| Профили пользователей | 7 ТБ | текст профиля 200 символов: (16КБ + 200 * 1.5Б) * 430M |
| Вопросы | 0.5 ГБ | 75Б * 5.84M |
| Текст ответов | 19 ГБ | 639Б * 29.2M |
| Изображения ответов | 2.2 ТБ | 86.8КБ * 29.2M * 0.85 |
| Итог | = ~9.2 ТБ | |

## 3. Глобальная балансировка

### Расположение датацентров

Основано на расположении ДЦ AWS ([2](https://docs.aws.amazon.com/global-infrastructure/latest/regions/aws-regions.html))

| Регион | Расположение ДЦ | Пользователи |
|--------|-----------------|--------------|
| США | Северная Вирджиния, Огайо, Северная Калифорния | 148M |
| Индия | Мумбаи, Хайдарабад | 100M |
| Европа | Германия (Франкфурт), Великобритания (Лондон), Швеция (Стокгольм) | 78M |
| Канада | Торонто | 20M |
| Юго-Восточная Азия | Сингапур | 24M |
| Средний Восток и Северная Африка | ОАЭ (Дубай) | 15M |
| Австралия и Новая Зеландия | Австралия (Сидней) | 11M |
| Япония | Токио | 6.8M |
| Мексика | Мехико | 3.5M |
| Бразилия | Сан-Паулу | 2.6M |

Для балансировки используется GeoDNS, т.к. ДЦ расположены в разных регионах на больших расстояниях.

Используется DNS Failover для переключения на сосведние ДЦ при отказе основных ДЦ зоны.

### Разбиение на поддомены

| Поддомен | Назначение | Характер трафика | RPS |
|----------|------------|------------------|-----|
| `quora.com` | Основной домен. | Минимальный | 313 |
| `api.quora.com` | Операций создания и изменения данных (вопросы, ответы, подписки). | Средний, write-heavy | 115 |
| `search.quora.com` | Поисковый сервис. | Высокий, read-heavy | 313 |
| `content.quora.com` | Операции чтения данных (вопросы, ответы, темы). | Очень высокий, read-heavy | 1470 |
| `images.quora.com` | Хостинг изображений. | Высокий, bandwidth-heavy | 1271 |
| `static.quora.com` | Статические ресурсы. | Высокий, cacheable | 313 |
| `auth.quora.com` | Авторизация и профили. | Средний | 313 |

## 4. Локальная балансировка

**L4 - HAProxy/Nginx:**
- Балансировка TCP/UDP соединений
- Используется для статики и изображений
- Алгоритм: Round Robin с весами по производительности серверов

**L7 - Nginx/Envoy:**
- Балансировка HTTP/HTTPS запросов
- Используется для API, поиска и контента
- Алгоритм: Least Connections с health checks

Оркестрация через Kubernetes, SSL Termination для снижения нагрузки на серверы.

### Серверы по поддоменам на один ДЦ:

Проведем расчет для одного ДЦ США, т.е. 148M / 3 = 49M пользователей => доля общего RPS = 49M / 430M = 0.11

Для остальных ДЦ числа будут пропорциональны их числу пользователей (~RPS).

Умножим RPS из таблицы поддоменов на 0.11 и получим:

| Поддомен | RPS | Серверы | RPS/сервер |
|----------|-----|---------|------------|
| `content.quora.com` | 162 | 10 | 16 |
| `images.quora.com` | 140 | 8 | 18 |
| `search.quora.com` | 35 | 4 | 9 |
| `static.quora.com` | 35 | 4 | 9 |
| `auth.quora.com` | 35 | 4 | 9 |
| `api.quora.com` | 13 | 3 | 4 |

Т.к. используем K8s, серверами у нас будут поды. Скажем, используем AWS инстансы c5.large (2 vCPU, 4GB RAM) для нод кластера. В AWS существует готовое решение EKS для K8s кластеров, но использовать его здесь не будем.

Оценим, что инстанс c5.large как рабочая нода может поддерживать работу 6 подов под максимальной нагрузкой (каждый под около 0.3 vCPU и 600MB RAM). Учтем, что на ноду должен быть один Ingress под, остальных остается 5.

Всего у нас 33 пода => требуется минимум 33 / 5 = 7 рабочих нод. Для надежности используем 10 нод, чтобы выдержать падение 3 из них.

Поды для обеспечения надежности каждого отдельного домена будут распределяться по разным нодам (podAntiAffinity).

Из-за особенности работы etcd ([3](https://thenewstack.io/how-many-nodes-for-your-kubernetes-control-plane/)), использование даже 2 мастер-нод недостаточно надежно. Советуется использовать 3 или 5 мастер-нод. Будем использовать 5.

Ingress поды требуются, т.к. нода K8s может по умолчанию иметь только L4 балансировщик kube-proxy. Но нам необходимо обрабатывать запросы на DNS поддомены и выполнять SSL Termination. Ingress поды будут распределять запросы внутри каждой отдельной рабочей ноды.

Над рабочими нодами будут L4 балансировщики, не обрывающие SSL. Сделаем active/passive (не active/active, т.к. в приоритете надежность, а не скорость) кластер из 3х балансировщиков для обеспечания надежности. Для примера, Nginx Plus и Haproxy Enterprise могут быть настроены как L4 балансировщики в режиме кластера active/passive.

Схема локальной балансировки:

![local balancing](assets/images/local-balancing.drawio.png)

## Список используемых источников
1. https://www.demandsage.com/quora-statistics/
2. https://docs.aws.amazon.com/global-infrastructure/latest/regions/aws-regions.html
3. https://thenewstack.io/how-many-nodes-for-your-kubernetes-control-plane/
